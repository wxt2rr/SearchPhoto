# 本地照片语义搜索工具 - 技术方案

## 1. 技术架构概览

### 1.1 架构原则
- **前后端分离**：前端负责UI体验，后端负责AI模型处理和复杂计算
- **本地运行**：前后端服务均在用户本地设备运行，不依赖外部服务
- **数据安全**：用户照片和数据不离开设备，所有处理在本地完成
- **模块化设计**：各功能组件独立，前后端职责分明，易于维护和扩展
- **渐进增强**：基础功能在所有现代浏览器运行，高级功能在支持的环境中启用

### 1.2 技术栈选择

#### 1.2.1 前端技术栈
- **前端框架**：Vue 3 + TypeScript
- **构建工具**：Vite 4
- **样式框架**：Tailwind CSS
- **UI组件库**：shadcn/ui-vue（Vue版本的shadcn/ui组件库）
- **状态管理**：Pinia
- **路由管理**：Vue Router 4
- **本地存储**：IndexedDB + localStorage
- **HTTP客户端**：Axios
- **代码格式化**：ESLint + Prettier

#### 1.2.2 后端技术栈
- **编程语言**：Python 3.8+
- **Web框架**：Flask 或 FastAPI
- **AI框架**：PyTorch/TensorFlow + Sentence-Transformers + CLIP
- **数据库**：SQLite（用于存储元数据）
- **图像处理**：Pillow、OpenCV
- **向量处理**：NumPy、Faiss

## 2. 前端技术架构

### 2.1 项目结构
```
src/
├── assets/                 # 静态资源
├── components/            # 公共组件
│   ├── FileProcessor/     # 文件处理相关组件
│   ├── ImageGrid/         # 图片网格展示组件
│   ├── SearchBar/         # 搜索框组件
│   └── ...
├── composables/           # Vue 3 Composables
│   ├── useImageProcessor/ # 图片处理逻辑
│   ├── useSearch/         # 搜索逻辑
│   └── ...
├── api/                   # API接口封装
│   ├── imageApi.ts        # 图像处理API
│   ├── searchApi.ts       # 搜索API
│   └── index.ts           # API入口
├── stores/                # Pinia Store
│   ├── imageStore.ts      # 图片数据存储
│   ├── searchStore.ts     # 搜索历史和设置
│   └── ...
├── utils/                 # 工具函数
│   ├── fileUtils.ts       # 文件处理工具
│   ├── imageUtils.ts      # 图片处理工具
│   └── ...
├── views/                 # 页面组件
│   ├── Home.vue           # 主页面
│   ├── Search.vue         # 搜索结果页面
│   └── ...
├── types/                 # TypeScript类型定义
└── main.ts                # 应用入口
```

### 2.2 核心模块设计

#### 2.2.1 API接口模块 (API Layer)
```typescript
interface ApiService {
  extractFeatures(imagePath: string): Promise<FeatureVector>;
  searchByText(query: string): Promise<SearchResult[]>;
  searchByImage(imagePath: string): Promise<SimilarImage[]>;
  processFolder(folderPath: string): Promise<ProcessedImage[]>;
  updateIndex(): Promise<void>;
}
```

- 封装与后端服务的通信
- 提供统一的API接口给上层业务逻辑使用

#### 2.2.2 图片处理模块 (ImageProcessor)
```typescript
interface ImageProcessor {
  processFolder(folderPath: string): Promise<ProcessedImage[]>;
  generateThumbnail(imagePath: string, size?: number): Promise<string>;
  extractMetadata(imagePath: string): Promise<ImageMetadata>;
}
```

- 调用后端API处理图片
- 生成缩略图URL
- 提取图片元数据

#### 2.2.3 搜索引擎模块 (SearchEngine)
```typescript
interface SearchEngine {
  searchByText(query: string): Promise<SearchResult[]>;
  searchByImage(imagePath: string): Promise<SimilarImage[]>;
  getSearchHistory(): Promise<SearchHistory[]>;
  saveSearchQuery(query: string, resultCount: number): Promise<void>;
}
```

- 调用后端语义搜索API
- 管理搜索历史

### 2.3 前后端通信
- 前端通过HTTP API与本地后端服务通信
- 使用JSON格式传输数据
- 所有API调用均在localhost进行

### 2.4 状态管理
使用 Pinia 进行状态管理：
- `imageStore`: 管理图片数据、处理状态、索引状态
- `searchStore`: 管理搜索历史、当前搜索状态、结果缓存
- `uiStore`: 管理UI状态（主题、布局偏好等）

## 3. 后端技术架构（本地Python服务）

### 3.1 服务架构
- **后端服务**：Python Flask/FastAPI 本地服务
- **模型运行时**：PyTorch/TensorFlow 本地运行
- **通信协议**：HTTP API，服务运行在本地回环地址 (localhost)
- **安全机制**：仅绑定到本地地址，不对外网开放

### 3.2 服务启动与管理
- 前端应用启动时自动检测并启动Python后端服务
- 服务与前端应用同时关闭
- 服务运行在固定的本地端口（如 localhost:5000）

### 3.3 核心服务模块

#### 3.3.1 图像处理服务
```python
class ImageProcessingService:
    def extract_features(self, image_path: str) -> List[float]:
        """提取图像特征向量"""
    
    def generate_thumbnail(self, image_path: str, size: tuple) -> bytes:
        """生成缩略图"""
    
    def extract_metadata(self, image_path: str) -> dict:
        """提取图像元数据（EXIF等）"""
```

#### 3.3.2 语义搜索服务
```python
class SemanticSearchService:
    def __init__(self):
        self.text_encoder = load_text_model()
        self.image_encoder = load_image_model()
        self.index = load_search_index()
    
    def search_by_text(self, query: str) -> List[SearchResult]:
        """文本搜索"""
    
    def search_by_image(self, image_path: str) -> List[SimilarImage]:
        """以图搜图"""
    
    def get_image_features(self, image_path: str) -> List[float]:
        """获取图像特征"""
```

#### 3.3.3 索引管理服务
```python
class IndexManagementService:
    def create_index(self, image_paths: List[str]) -> None:
        """创建索引"""
    
    def update_index(self, new_paths: List[str], removed_paths: List[str]) -> None:
        """更新索引"""
    
    def save_index(self, path: str) -> None:
        """保存索引到本地文件"""
    
    def load_index(self, path: str) -> None:
        """从本地文件加载索引"""
```

### 3.4 前后端通信API
- **图像特征提取API**: `POST /api/extract-features`
- **图像搜索API**: `POST /api/search-by-image`
- **文本搜索API**: `POST /api/search-by-text`
- **索引管理API**: `POST /api/manage-index`
- **文件处理API**: `POST /api/process-files`

## 4. AI模型集成方案（本地Python后端）

### 4.1 模型选择与部署
- **文本编码器**：使用 Sentence-Transformers（如 all-MiniLM-L6-v2）将文本转换为向量
- **图像编码器**：使用 CLIP 模型或其他视觉模型提取图像特征
- **模型存储**：模型文件存储在应用本地
- **模型加载**：服务启动时一次性加载到内存

### 4.2 模型推理优化
- 使用 GPU 加速（如果可用）
- 模型量化以减少内存占用和提高推理速度
- 批量推理优化

### 4.3 模型文件管理
- 模型文件与应用一起分发
- 首次运行时解压到本地缓存目录
- 提供模型更新脚本

## 5. 数据处理流程（本地处理）

### 5.1 前端文件选择
- 使用 File API 获取用户选择的文件夹内容
- 通过前端界面将文件路径信息传递给后端服务

### 5.2 后端数据处理
- Python后端服务处理图像特征提取
- 图像元数据提取（EXIF、时间、位置等）
- 特征向量计算和存储

### 5.3 搜索计算流程
- 文本查询发送到后端进行向量化
- 向量相似度计算在后端完成
- 搜索结果返回给前端展示

## 6. 数据库/存储方案

### 6.1 前端存储
- **IndexedDB**: 存储图片元数据、UI状态、搜索历史等轻量数据
- **localStorage**: 存储用户配置、应用设置等
- **Cache API**: 缓存缩略图和搜索结果

### 6.2 后端存储
- **本地文件系统**: 存储特征索引文件、模型文件、缓存数据
- **SQLite数据库**: 存储图片路径、元数据、索引映射等

### 6.3 存储结构设计
```typescript
// 前端存储的图片信息
interface ClientImageInfo {
  id: string;
  path: string; // 仅存储相对路径或文件名，不包含完整路径
  fileName: string;
  size: number;
  lastModified: number;
  mimeType: string;
  width: number;
  height: number;
  dateTimeOriginal?: string; // EXIF信息
  location?: Location; // 地理位置
  thumbnail: string; // 缩略图URL（Data URL或本地路径）
}

// 搜索历史
interface SearchHistory {
  id: string;
  query: string;
  timestamp: number;
  resultCount: number;
}
```

```python
# 后端存储的数据结构
from dataclasses import dataclass
from typing import List, Optional

@dataclass
class ImageMetadata:
    id: str
    path: str  # 本地绝对路径
    file_name: str
    size: int
    last_modified: float
    mime_type: str
    width: int
    height: int
    date_time_original: Optional[str]
    location: Optional[dict]
    features: List[float]  # 特征向量

@dataclass
class SearchResult:
    image_id: str
    similarity: float
    metadata: ImageMetadata
```

## 7. 安全和隐私保护方案

### 7.1 数据安全
- 所有数据存储在本地，不上传到任何外部服务器
- 后端服务仅绑定到 localhost，不对外网开放
- 使用 HTTPS（本地自签名证书）对本地通信加密

### 7.2 隐私保护
- 不收集任何用户数据
- 不追踪用户行为
- 不发送任何数据到外部服务
- 提供一键清除所有本地数据功能
- 路径信息脱敏，前端不存储完整路径

### 7.3 服务安全
- 服务只在用户主动使用应用时运行
- 端口访问限制，仅允许前端页面访问
- 请求验证，防止恶意调用

## 8. 性能优化策略

### 8.1 前端性能
- 图片懒加载和虚拟滚动
- Service Worker 缓存静态资源
- Web Workers 处理非核心任务

### 8.2 后端性能
- 模型预加载到内存，减少推理延迟
- 使用 GPU 加速推理（如果可用）
- 批量处理多个图像
- 内存映射文件优化大索引访问

### 8.3 通信优化
- HTTP/1.1 连接复用
- 请求/响应数据压缩
- 本地网络延迟极低

## 8. 部署和打包方案

### 8.1 前后端整合打包
- 前端应用使用 Vite 构建为静态文件
- Python后端打包为可执行文件（使用 PyInstaller 或 Nuitka）
- 整体打包为桌面应用（使用 Tauri 或 Electron）

### 8.2 服务启动方案
- 前端应用启动时自动检测并启动后端Python服务
- 服务启动状态检查和错误处理
- 优雅关闭前后端服务
- 服务运行在本地回环地址 (localhost)

### 8.3 环境依赖管理
- Python运行时打包到应用中或要求用户预装
- 模型文件作为资源包含在发布包中
- 自动环境检测和依赖安装脚本

## 9. 开发和测试策略

### 9.1 开发工作流
- 分别开发前端和后端，通过API文档协调
- 前端Mock服务开发，后端API开发
- TypeScript + Python 类型定义确保接口一致性

### 9.2 测试策略
- 前端单元测试：Vitest
- 后端单元测试：pytest
- 集成测试：测试前后端API交互
- 端到端测试：Playwright

## 10. 开发和测试策略

### 10.1 开发工作流
- 分别开发前端和后端，通过API文档协调
- 前端Mock服务开发，后端API开发
- TypeScript + Python 类型定义确保接口一致性

### 10.2 测试策略
- 前端单元测试：Vitest
- 后端单元测试：pytest
- 集成测试：测试前后端API交互
- 端到端测试：Playwright

## 11. 扩展性考虑

### 11.1 模块化设计
- 前后端功能模块化
- 标准API接口定义，便于替换实现
- 插件化模型支持

### 11.2 性能扩展
- 模型推理支持GPU加速
- 索引分片支持大量数据
- 分布式搜索预留接口

## 12. 与云端API的区别

### 12.1 数据处理
- 云端方案：上传图片到远程服务器进行分析处理
- 本地方案：所有处理在用户本地设备完成，数据不离开设备

### 12.2 服务部署
- 云端方案：服务运行在远程数据中心
- 本地方案：服务运行在用户本地设备，仅在localhost运行

### 12.3 隐私保护
- 云端方案：存在数据泄露风险
- 本地方案：用户数据完全保留在本地，无泄露风险

### 12.4 网络依赖
- 云端方案：需要网络连接
- 本地方案：无需网络连接，完全离线运行

这个技术方案结合了前端Vue.js和后端Python的优势，在保证数据安全和隐私的前提下，利用Python在AI模型处理方面的优势，实现了高性能的本地图像搜索功能。